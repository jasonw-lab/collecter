# -*- coding: utf-8 -*-
"""Fetch CVE descriptions from NVD and create markdown files."""

import os
import re
import time

import requests
from bs4 import BeautifulSoup

INPUT_CSV = "cve-input.csv"
CVE_RE = re.compile(r"CVE-\d{4}-\d+")
REQUEST_SLEEP_SECONDS = 2


def load_cve_list(csv_path):
    """
    Extract CVE IDs from the input CSV. Only lines with CVE IDs are used.
    Duplicates are removed while preserving order.
    """
    cve_list = []
    seen = set()

    if not os.path.exists(csv_path):
        print(f"Warning: {csv_path} not found.")
        return cve_list

    with open(csv_path, "r", encoding="utf-8", errors="replace") as f:
        for line in f:
            for cve_id in CVE_RE.findall(line):
                if cve_id not in seen:
                    seen.add(cve_id)
                    cve_list.append(cve_id)

    return cve_list


def get_cve_description(cve_id):
    """
    Fetch the CVE description for a given CVE ID.

    Args:
        cve_id (str): CVE ID (e.g., CVE-2025-15284)

    Returns:
        str: Description text, or None on failure
    """
    url = f"https://nvd.nist.gov/vuln/detail/{cve_id}"

    try:
        print(f"\n{'='*80}")
        print(f"Fetching: {cve_id}")
        print(f"URL: {url}")
        print(f"{'='*80}")

        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
        }
        response = requests.get(url, headers=headers, timeout=30)
        response.raise_for_status()

        soup = BeautifulSoup(response.content, "html.parser")
        description_element = soup.find("p", {"data-testid": "vuln-description"})

        if not description_element:
            print(f"Warning: description not found for {cve_id}")
            return None

        description_text = description_element.get_text(separator=" ", strip=True)
        description_text = " ".join(description_text.split())
        print("\nDescription:")
        print(description_text)

        script_dir = os.path.dirname(os.path.abspath(__file__))
        template_path = os.path.join(script_dir, "CVE-template.md")
        cve_list_dir = os.path.join(script_dir, "cve-list")
        output_filename = os.path.join(cve_list_dir, f"{cve_id}.md")

        try:
            os.makedirs(cve_list_dir, exist_ok=True)

            with open(template_path, "r", encoding="utf-8", errors="replace") as f:
                template_content = f.read()

            md_content = re.sub(r"\{CVE[^}]*\}", cve_id, template_content)
            md_content = insert_description(md_content, description_text)

            with open(output_filename, "w", encoding="utf-8") as f:
                f.write(md_content)

            print(f"Saved: {output_filename}")
        except Exception as e:
            print(f"Warning: failed to save file - {e}")

        return description_text

    except requests.exceptions.RequestException as e:
        print(f"Error: failed to fetch {cve_id} - {e}")
        return None
    except Exception as e:
        print(f"Error: unexpected failure for {cve_id} - {e}")
        return None


def main():
    """Main entry point."""
    script_dir = os.path.dirname(os.path.abspath(__file__))
    csv_path = os.path.join(script_dir, INPUT_CSV)
    cve_list = load_cve_list(csv_path)

    print("NVD CVE fetch script")
    print(f"CVE count: {len(cve_list)}")

    results = {}

    for cve_id in cve_list:
        description = get_cve_description(cve_id)
        results[cve_id] = description

        if len(cve_list) > 1:
            time.sleep(REQUEST_SLEEP_SECONDS)

    print(f"\n{'='*80}")
    print("Summary")
    print(f"{'='*80}")
    success_count = sum(1 for v in results.values() if v is not None)
    print(f"Success: {success_count}/{len(cve_list)}")

    for cve_id, description in results.items():
        status = "OK" if description else "NG"
        print(f"{status} {cve_id}")


def insert_description(md_content, description_text):
    """
    Insert Description under the first subheading in the Description section.
    This targets the English subsection in the current template.
    """
    block_re = re.compile(r"(# Description\s*\n## .+\n)([\s\S]*?)(\n## .+\n)", re.M)
    m = block_re.search(md_content)
    if m:
        return block_re.sub(
            r"\1" + description_text + r"\n\n\3",
            md_content,
            count=1,
        )

    # Fallback: insert directly after the Description header
    return md_content.replace(
        "# Description\n", f"# Description\n{description_text}\n\n", 1
    )


if __name__ == "__main__":
    main()
